# 휴리스틱 설계

'상황에 따라서'라는 말은 거의 모든 질문에 맞는 답변이지만, 실전에는 별로 도움이 되지 않는다.

<br/>

## 휴리스틱

휴리스틱은 모든 상황에 맞게 보장되고 수학적으로 검증된 규칙이 아니다. 오히려 완벽한 것을 보장하지 않지만 당면한 목적에 충분할 만큼의 경험에 기반한 규칙이다.

다시 말해, 휴리스틱을 사용하는 것은 수많은 단서에 내재된 노이즈를 무시하면서도 가장 중요한 단서에서 느껴지는 '압도하는 힘'에 집중하여 효과적으로 문제를 해결하는 접근법이다.

<br/>

## 바운디드 컨텍스트

여러 바운디드 컨텍스트에 영향을 미치는 소프트웨어의 변경은 비싸고 수많은 조율이 필요하다.

특히, 영향을 받은 바운디드 컨텍스트를 다양한 팀에서 구현한 경우에는 더욱 그렇다.

또한 이런 변경이 단일 바운디드 컨텍스트 범위 내에 있지 않다면 이는 컨텍스트 경계의 설계가 효과적이지 않다는 신호다.

바운디드 컨텍스트의 경계를 무효화하는 변경은 일반적으로 비즈니스 도메인이 잘 알려져 있지 않거나 비즈니스 요구사항이 번번하게 바뀔 때 발생한다.

바운디드 컨텍스트의 경계를 설계할 때 이런 특성을 휴리스틱으로 사용할 수 있다.

<br/>

## 비즈니스 로직 구현 패턴

트랜잭션 스크립트와 액티브 레코드 패턴은 둘 다 간단한 비즈니스 로직을 포함하는 하위 도메인에 적합하다.

도메인 모델과 그 변형인 이벤트 소싱 도메인 모델은 복잡한 비즈니스 로직을 가진 핵심 하위 도메인에 적합하다.

비즈니스 로직의 적절한 구현 패턴을 선택하기 위한 효과적인 휴리스틱은 다음과 같은 질문을 해보는 것이다.

- 하위 도메인이 금전 또는 통화의 트랜잭션을 추적하거나, 일관된 감사 로그를 제공하거나, 비즈니스에서 하위 도메인의 동작에 대한 심층적인 분석을 요청하는가? 그렇다면 이벤트 소싱 도메인 모델을 적용한다. 그렇지 않다면
- 하위 도메인의 비즈니스 로직이 복잡한가? 그렇다면 도메인 모델을 구현한다. 그렇지 않다면
- 하위 도메인이 복잡한 자료구조를 포함하는가? 그렇다면 액티브 레코드 패턴을 사용한다. 그렇지 않다면
- 그것이 아니라면 트랜잭션 스크립트를 구현한다.

하위 도메인의 복잡성과 그 유형은 강한 관계가 있으므로 도메인 주도 의사결정 트리로 나타낼 수 있다.

<br/>

## 아키텍처 패턴

세 가지 아키텍처 패턴

- 계층형 아키텍처
- 포트와 어댑터
- CQRS

이 아키텍처 패턴이 의도한 비즈니스 로직 구현 패턴을 알면 쉽게 아키텍처 패턴을 선정할 수 있다.

- 이벤트 소싱 도메인 모델은 CQRS가 필요하다. 그렇지 않으면 시스템은 데이터 질의 옵션이 극심하게 제한되어 자신의 ID만으로 단일 인스턴스를 가져와야 한다.
- 도메인 모델은 포트와 어댑터 아키텍처가 필요하다. 계층형 아키텍처에서는 영속성에 대한 고려 없이 애그리게이트와 밸류 오브젝트를 만들기가 어렵다.
- 액티브 레코드 패턴은 애플리케이션(서비스) 계층을 추가한 계층형 아키텍처와 잘 어울린다. 이는 액티브 레코드를 제어하는 로직을 위한 것이다.
- 트랜잭션 스크립트 패턴은 세 개의 계층만으로 이어진 최소한의 계층형 아키텍처를 적용하여 구현할 수 있다.

휴리스틱에서 유일한 예외는 CQRS 패턴이다. CQRS는 이벤트 소싱 도메인 모델에 도움이 될 뿐만 아니라 하위 도메인이 여러 영속성 모델에 있는 데이터를 표현할 필요가 없는 경우도 도움이 된다.

<br/>

## 테스트 전략

비즈니스 구현 패턴과 아키텍처 패턴의 모든 지식은 코드베이스의 테스트 전략을 선택할 때 휴리스틱으로써 활용할 수 있다.

엔드-투-엔드, 통합, 단위의 여러 가지 테스트 유형, 강조하는 유형에 따라 테스트 전략을 나눴다.

<br/>

#### 피라미드형 테스트

고전적인 피라미드형 테스트 전략에서는 단위 테스트를 강조하고 통합 테스트는 별로 없으며, 엔드-투-엔드 테스트는 더더욱 없다.

피라미드형 테스트는 애그리게이트와 밸류 오브젝트 도메인 모델 패턴을 모두 잘 지원한다.

<br/>

#### 다이아몬드형 테스트

다이아몬드형 테스트에서 가장 집중하는 유형은 통합 테스트다. 액티브 레코드 패턴이 사용되면 시스템의 비즈니스 로직은 서비스 계층과 비즈니스 로직 계층에 흩어지므로 두 계층은 연동에 중점을 둔다면 다이아몬드형 테스트가 더 효과적인 선택이다.

<br/>

#### 역전된 피라미드형 테스트

역전된 피라미드형 테스트 전략은 엔드-투-엔드 테스트에 가장 많이 집중한다.

이 같은 접근 방법은 트랜잭션 스크립트 패턴을 구현한 코드베이스에 가장 잘 어울린다. 이 경우, 비즈니스 로직이 간단하고 계층의 수가 적으므로 이 테스트 전략이 시스템의 엔드-투-엔드 흐름을 검증하는 데 더 효과적이다.

<br/>

## 전술적 설계 의사결정 트리

비즈니스 로직 패턴, 아키텍처 패턴, 테스트 전략에 관한 휴리스틱은 하나의 전술적 설계 의사결정 트리로 합쳐서 요약할 수 있다.

이처럼 하위 도메인의 유형을 식별하고 의사결정 트리를 참조하는 것은 필수적인 설계 의사결정을 위한 시작점이다.

특정 상황에 따라 효과적인 접근 방법은 달라진다. 그러므로 의사결정 트리는 중요한 의사결정 방식을 대체하는 것이 아닌 가이드 규칙으로만 사용하자. 당면한 문제에 더 잘 맞는 다른 휴리스틱을 찾는다면 가이드 원칙을 개선하거나 모두 함께 자신만의 의사결정 트리를 만들도록 한다.

<br/>

## 결론

휴리스틱 기반 의사결정 프레임워크와 연관 지었다. 기술적 의사결정을 내리는 데 비즈니스 도메인 지식과 그 하위 도메인을 적용하는 방법을 배웠다.

안전한 바운디드 컨텍스트 경계를 선택하기, 애플리케이션의 비즈니스 로직을 모델링하기, 각 바운디드 컨텍스트의 내부 구성요소를 조율하는 데 필요한 아키텍처 패턴을 결정하는 방법이 있다.

동일한 프레임워크를 적용해 비즈니스 도메인에 따라 다양한 테스트의 우선순위를 정했다.

설계 의사결정을 내리는 것도 중요하지만, 더 중요한 것은 시간이 지나면서 과거의 의사결정이 여전히 유효한지를 검증하는 것이다.

<br/>

# 느낀점

휴리스틱을 이용한 의사결정 트리에 대해서 잘 알게 되었다.