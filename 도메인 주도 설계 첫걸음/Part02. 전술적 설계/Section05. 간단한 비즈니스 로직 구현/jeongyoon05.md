# 간단한 비즈니스 로직 구현

비즈니스 로직은 소프트웨어에서 가장 중요한 부분이며 애초에 소프트웨어를 구현하는 이유이기도 하다.

시스템의 사용자 인터페이스는 매력적일 수 있고 데이터베이스는 놀랍도록 빠르고 확장 가능할 수 있다.

<br/>

## 트랜잭션 스크립트

```
"프레젠테이션으로부터 단일 요청을 처리하는 여러 프로시저를 모아서 비즈니스 로직을 구현해라."
																							   	-마틴 파울러
```

시스템 퍼블릭 인터페이스는 사용자가 실행할 수 있는 비즈니스 트랜잭션의 모음으로 볼 수 있다. 이러한 트랜잭션은 시스템에서 관리하는 정보를 검색, 수정 또는 둘다 할 수 있다.

트랜잭션 스크립트 패턴은 프로시저를 기반으로 시스템의 비즈니스 로직을 구성하며, 각 프로시저는 퍼블릭 인터페이스를 통해 시스템 사용자가 실행하는 작업을 구현한다.

<br/>

#### 구현

저장 장치와 연동하기 위해 얇은 추상화 계층을 사용할 수 있지만 데이터베이스에 접근도 가능하다.

각 작업은 성공하거나 실패할 수 있지만, 유효하지 않은 상태를 만들면 안 된다.

가장 곤란한 순간에 트랜잭션 스크립트 실행이 실패하더라도 시스템은 오류가 발생할 때까지 변경사항을 롤백하거나 보상 조치를 실행하여 일관성을 유지해야 한다.

<br/>

#### 그렇게 쉽진 않다!

트랜잭션 스크립트 패턴이 고급 비즈니스 로직 구현 패턴의 기반이다. 겉보기는 단순하지만 가장 틀리기 쉬운 패턴이다.

트랜잭션 스크립트를 올바르게 구현하지 못해 발생하는 데이터 손상이 있을 수 있다.

<br/>

#### 트랜잭션 동작 구현 실패

트랜잭션 동작 구현에 실패한 간단한 예는 전체를 아우르는 트랜잭션 없이 여러 업데이트를 하는 경우다.

관계형 데이터베이스에서 기본으로 지원하는 기능을 활용해서 여러 레코드에 걸친 트랜잭션을 쉽게 구현할 수 있다.

다중 레코드 트랜잭션을 지원하지 않는 데이터베이스에서 다중 업데이트를 하거나 분산 트랜잭션에서 통합할 수 없는 여러 개의 저장 장차로 작업하는 경우에는 상황이 더 복잡해진다.

<br/>

#### 분산 트랜잭션

여러 저장 장치에 걸쳐 있는 분산 트랜잭션은 복잡하고 확장하기 어렵고 오류가 발생하기 쉬우므로 일반적으로 피하는 방식이다.

<br/>

#### 암시적 분산 트랜잭션

메서드가 수행하는 모든 작업은 하나의 데이터베이스에 있는 하나의 테이블에서 하나의 값을 업데이트하는 것이다. 이것은 여전히 잠재적으로 일관성 없는 상태로 이어질 수 있는 분산 트랜잭션이다.

같은 요청을 여러 번 반복하더라도 그 결과는 매번 동일하게 만드는 것을 멱등성으로 만든다고 한다.

작업을 여러 번 실행하더라도 최종 결과는 변경되지 않는 문제를 해결하기 위해 낙관적 동시성 제어를 사용하면 된다.

<br/>

#### 트랜잭션 스크립트를 사용하는 경우

트랜잭션 스크립트 패턴은 비즈니스 로직이 단순한 절차적 작업처럼 매우 간단한 문제 도메인에 효과적이다.

트랜잭션 스크립트 패턴은 정의상 비즈니스 로직이 단순한 지원 하위 도메인에 적합하다.

트랜잭션 스크립트 패턴의 주요 장점은 단순함이다.

핵심 하위 도메인에는 트랜잭션 스크립트를 사용하면 안 된다.

<br/>

## 액티브 레코드

```
"데이터베이스 테이블 또는 뷰의 행을 감싸고 데이터베이스 접근을 캡슐화하고 해당 데이터에 도메인 로직을 추가하는 오브젝트"
																								  -마틴 파울러
```

트랜잭션 스크립트 패턴과 마찬가지로 액티브 레코드는 비즈니스 로직이 단순한 경우 사용된다. 그러나 액티브 레코드는 좀 더 복잡한 자료구조에서도 비즈니스 로직이 작동할 수 있다.

<br/>

#### 구현

이 패턴은 액티브 레코드라고 하는 정용 객체를 사용하여 복잡한 자료구조를 표현한다.

이외에 데이터 접근 방법(CRUD)도 구현하기 때문에 액티브 레코드 객체는객체 관계 매핑과 관련이 있다.

액티브 레코드는 데이터 접근 로직을 구현한다.

액티브 레코드는 데이터베이스에 직접 접근하는 대신 트랜잭션 스크립트가 액티브 레코드 객체를 조작한다.

이 패턴의 목적은 메모리 상의 객체를 데이터베이스 스키마에 매핑하는 복잡성을 숨기는 것이다.

액티브 레코드 객체의 고유한 기능은 자료구조와 동작(비즈니스 로직)의 분리다.

<br/>

#### 액티브 레코드를 사용하는 경우

액티브 레코드는 본질적으로 데이터베이스에 대한 접근을 최적화하는 트랜잭션 스크립트이기 때문에 이 패턴은 기껏해야 사용자 입력의 유효성을 검사하는 CRUD 작업과 같은 비교적 간단한 비즈니스 로직만 지원할 수 있다.

트랜잭션 스크립트 패턴과 마찬가지로 액티브 레코드 패턴은 지원 하위 도메인, 일반 하위 도메인과 외부 솔루션의 연동, 모델 변환 작업에 적합하다. 

액티브 레코드 패턴은 **빈약한 도메인 모델 안티패턴**이라고 한다.

이 패턴은 도구다. 다른 도구와 미찬가지로 문제를 해결할 수 있지만 잘못된 컨텍스트에 적용하면 잠재적으로 득보다 실이 더 많을 수 있다.

<br/>

## 실용적인 접근 방식

대규모로 데이터를 다루는 시스템에서는 데이터의 일관성 보장이 덜 엄격할 수 있다.

```
ex) 100만 개 중 하나의 레코드 상태를 손상시키는 것이 실제로 비즈니스에 쇼스토퍼가 되는지, 그리고 비즈니스 성과와 수익성에 영향을 주는지 확인한다.
```

항상 그렇듯이 보편적 법칙은 없다. 그것은 작업 중인 비즈니스 도메인에 달려있다.

<br/>

## 결론

- ##### 트랜잭션 스크립트

  - 이 패턴은 시스템 작업을 간단하고 쉬운 절차지향 스크립트로 구성한다.
  - 이 절차는 작업에 트랜잭션을 적용해서 작업이 성공하거나 실패하도록 보장한다.
  - 트랜잭션 스크립트 패턴은 ETL처럼 단순한 비즈니스 로직을 가진 지원 하위 도메인에 적합하다.

- ##### 액티브 레코드

  - 비즈니스 로직이 단순하지만 복잡한 자료구조에서 작동하는 경우 해당 자료구조를 액티브 레코드로 구현할 수 있다.
  - 액티브 레코드 객체는 간단한 CRUD 데이터 접근 방법을 제공하는 자료구조다.

<br/>

# 느낀점

트랜잭션 스크립트 패턴과 액티브 레코드 패턴에 대해서 잘 알게 되었다.