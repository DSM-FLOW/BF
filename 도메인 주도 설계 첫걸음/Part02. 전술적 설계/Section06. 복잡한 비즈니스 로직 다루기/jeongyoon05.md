# 복잡한 비즈니스 로직 다루기

비즈니스 로직의 구현에 대해 다루고 복잡한 비즈니스 로직에 사용되는 도메인 모델 패턴을 알아보자.

<br/>

## 배경

에반스는 자신의 책에서 비즈니스 도메인의 하위 모델과 코드를 긴밀하게 연결 잣는데 쓰이는 에그리게이트, 벨류 오브젝트, 레포지토리 등과 같은 패턴을 제시했다.

에반스가 소개한 패턴은 종종 '**전술적 도메인 주도 설계**'로 불린다.

이 패턴이 '도메인 모델'이고 애그리게이트와 밸류 오브젝트는 그 구성요소다.

<br/>

## 도메인 모델

도메인 모델 패턴은 복잡한 비즈니스 로직을 다루기 위한 것이다.

헬프데스크 시스템을 구현한다고 가정해보자.

- 고객은 직면한 문제를 설명하는 지원 티켓을 연다.
- 고객과 지원 할당된 에이전트 모두 메시지를 추가하고 모든 내용은 지원 티켓에서 관리된다.
- 각 티켓은 낮음, 중간, 높음, 긴급의 우선순위를 갖는다.
- 에이전트는 티켓의 우선순위에 따른 SLA(응답 제한 시간) 내에 해법을 제시해야 한다.
- 할당된 에이전트가 응답 제한 시간 내에 응답하지 못하면 고객은 티켓을 에이전트의 상위 관리자에게 보고되게 할 수 있다.
- 티켓이 상위 관리자에게 보고되면 에이전트의 응답 제한 시간이 33% 줄어든다.
- 에이전트가 상부 보고된 티켓의 응답 제한 시간의 절반이 지나기 전에 티켓을 열람하지 않으면 자동으로 다른 에이전트가 할당된다.
- 할당된 에이전트의 질문에 고객이 7일 이내에 응답하지 않으면 티켓은 자동으로 닫힌다.
- 상부 보고된 티켓은 자동으로 또는 할당된 에이전트에 의해 닫힐 수 없고 고객 또는 에이전트의 매니저만 닫을 수 있다.
- 고객은 티켓이 닫힌 지 7일 이내에 닫힌 티켓을 다시 열 수 있다.

이 같은 요구사항은 다양한 규칙 간에 그물 같은 의존성을 형성하고, 모든 규칙은 지원 티켓의 수명주기 관리 로직에 영향을 준다.

<br/>

#### 구현

도메인 모델은 행동과 데이터 모두를 포함하는 도메인의 객체 모델이다.

DDD의 전술 패턴인 에그리게이트, 벨류 오브젝트, 도메인 이벤트, 도메인 서비스는 모두 객체 모델의 구성요소다.

<br/>

#### 복잡성

도메인 비즈니스 로직은 이미 본질적으로 복잡하므로 모델링에 사용되는 객체가 모델에 조금이라도 우발적 복잡성을 추가하면 안 된다.

데이터베이스 또는 외부 시스템 구성요소의 호출 구현 같은 인프라 또는 기술적인 관심사를 피하지 않으면 모델의 객체는 **플레인 올드 오브젝트**가 된다.

플레인 올드 오브젝트는 인프라 구성 요소 또는 프레임워크에 의지하지 않고 직접 협업하지 않으면서 비즈니스 로직을 구현하는 객체다.

<br/>

#### 유비쿼터스 언어

도메인 모델의 객체가 기술적 관심사가 아닌 비즈니스 로직에 집중하게 하면 바운디드 컨텍스트에서 사용하는 유비쿼터스 언어의 용어를 따르기 쉬워진다.

<br/>

#### 구성요소

벨류 오브젝트, 에그리게이트, 도메인 서비스와 같은 DDD에서 제공하는 도메인의 모델의 구성요소와 전술적 패턴을 살피자.

<br/>

#### 벨류 오브젝트

벨류 오브젝트는 복합적인 값에 의해 식별되는 객체다.

##### 유비쿼터스 언어

언어의 표준 라이브러리에 포함된 문자열, 정수, 딕셔너리 같은 원시 데이터 타입에 전적으로 의존해서 비즈니스 도메인의 개념을 표현하는 것은 원시 집착 코드 징후로 알려져 있다.

벨류 오브젝트를 사용하면 코드에서 유비쿼터스 언어를 사용하게 하므로 코드에서 비즈니스 도메인의 개념을 표현하게 된다는 것이다.

##### 구현

벨류 오브젝트는 불변의 객체로 구현되므로 밸류 오브젝트에 있는 필드가 하나라도 바뀌면 다른 값이 생성된다.

벨류 오브젝트의 동일성은 id 필드나 참조 대신 값을 기반으로 하므로 동일성 검사 함수를 오버라이드해서 적절히 구현하는 것이 중요하다.

##### 벨류 오브젝트를 사용하는 경우

벨류 오브젝트는 가능한 모든 경우에 사용하는 게 좋다. 벨류 오브젝트는 코드의 표현력을 높여주고 분산되기 쉬운 비즈니스 로직을 한데 묵어줄 뿐만 아니라 코드를 더욱 안전하게 해준다.

벨류 오브젝트는 불변이기 때문에 내포된 동작은 부작용과 동시성 문제가 없다.	

<br/>

#### 엔티티

엔티티는 밸류 오브젝트와 정반대다. 엔티티는 다른 엔티티와 구별하기 위해 명시적인 식별 필드가 필요하다.

식별 필드의 핵심 요구사항은 각 엔티티의 인스턴스마다 고유해야 한다는 것이다.

벨류 오브젝트와 반대로, 엔티티는 불변이 아니고 변할 것으로 예상된다. 엔티티와 밸류 오브잭트의 또 다른 차이점은 밸류 오브젝트는 엔티티의 속성을 설명한다는 것이다.

<br/>

#### 애그리게이트

애그리게이트는 엔티티다. 즉, 명시적인 식별 필드가 필요하고 인스턴스의 생애주기 동안 상태가 변할 것으로 예상된다.

이 패턴의 목표는 데이터를 보호하는 데 있다.

애그리게이트의 데이터는 변할 수 있기 때문에 이 패턴에는 데이터의 일관성을 유지하기 위해 해결해야 할 과제가 있다는 의미도 포함돼 있다.

##### 일관성 강화

애그리게이트의 상태는 변형될 수 있으므로 데이터가 손상될 수 있는 여러 경로가 있다. 일관성을 강화하려면 주변에 명확한 경계를 설정해야 한다.

##### 트랜잭션 경계

 애그리게이트의 상태는 자신의 비즈니스 로직을 통해서만 수정할 수 있기 때문에 애그리게이트가 트랜잭션 경계의 역할을 한다.

##### 엔티티 계층

엔티티는 독립적 패턴이 아닌 애그리게이트의 일부로서만 사용된다.

DDD에서는 비즈니스 도메인이 시스템의 설계를 주도해야 한다고 규정한다. 애그리게이트도 마찬가지다.

##### 다른 애그리게이트 참조하기

애그리게이트 내의 모든 객체는 같은 트랜잭션 경계를 공유하기 때문에 애그리게이트가 너무 커지면 성능과 확장 문제가 생길 수 있다.

애그리게이트를 가능한 한 작게 유지하고 애그리게이트의 비즈니스 로직에 따라 강력하게 일관적으로 상태를 유지할 필요가 있는 객체만 포함한다.

##### 애그리게이트 루트

애그리게이트가 엔티티의 계층 구조를 대표하기 때문에 그중 하나만 애그리게이트의 퍼블릭 인터페이스, 즉 애그리게이트 루트로 지정돼야 한다.

##### 도메인 이벤트

> 비즈니스 도메인에서 일어나는 중요한 이벤트를 설명하는 메시지다.

ex) 

- 티켓이 할당돰
- 티켓이 상부에 보고됨
- 메시지가 수신됨

도메인 이벤트의 목적은 비즈니스 도메인에서 일어난 일을 설명하고 이벤트와 관련된 모든 필요한 데이터를 제공하는 것이다.

도메인 이벤트는 애그리게이트의 퍼블릭 인터페이스의 일부다. 애그리게이트는 자신의 도메인 이벤트를 발행한다.

##### 유비쿼터스 언어

애그리게이트는 유비쿼터스 언어를 사용해야 한다. 애그리게이트의 이름, 데이터 멤버, 동작 그리고 도메인 이벤트에 사용된 모든 용어는 모두 바운디드 컨텍스트의 유비쿼터스 언어로 명명돼야 한다.

<br/>

#### 도메인 서비스

> 비즈니스 로직을 구현한 상태가 없는 객체다.

대부분의 경우 이런 로직은 어떤 계산이나 분석을 수행하기 위한 다양한 시스템 구성요소의 호출을 조율한다.

도메인 서비스는 여러 애그리게이트의 작업을 쉽게 조율할 수 있다.

<br/>

#### 복잡성 관리

복잡한 것을 불변성으로 감싸서 복잡성을 낮추는 것이다.

비즈니스 로직은 비즈니스 불변성을 감싸고 보호해서 결국 자유도를 줄인다.

도메인 모델 패턴은 복잡한 비즈니스 로직을 갖는 하위 도메인에만 적용되므로 이를 소프트웨어의 중심인 핵심 하위 도메인으로 가정해도 좋다.

<br/>

## 결론

- ##### 벨류 오브젝트

  - 이것은 값만으로 식별되는 비즈니스 도메인의 개념이기 때문에 명시적인 ID 필드가 필요없다.
  - 필드 중 하나가 변경되면 의미상 새로운 값을 생성하므로 밸류 오브젝트는 불변이다.
  - 밸류 오브젝트는 데이터뿐만 아니라 행동도 모델링 한다. 즉, 메서드는 값을 조작하고 새로운 밸류 오브젝트를 초기화한다.

- ##### 애그리게이트

  - 트랜잭션 경계를 공유하는 엔티티의 계층이다.
  - 애그리게이트의 경계에 속하는 모든 데이터는 비즈니스 로직의 구현을 통해 강력한 일관성을 유지해야 한다.
  - 애그리게이트의 상태와 내부 객체는 애그리게이트의 커맨드를 실행하여 퍼블릭 인터페이스를 통해서만 수정될 수 있다.
  - 애그리게이트와 관련된 모든 비즈니스 로직이 경계 내에 존재하도록 외부 컴포넌트는 애그리게이트 내의 데이터 필드를 읽을 수만 있게 한다.
  - 애그리게이트는 트랜잭션의 경계 역할을 한다.
  - 내부 객체를 포함한 모든 데이터는 원자적인 단일 트랜잭션으로 데이터베이스에 커밋돼야 한다.
  - 애그리게이트는 도메인 이벤트를 게시하여 외부 엔티티와 커뮤니케이션할 수 있다.
  - 도메인 이벤트는 애그리게이트의 수명주기에서 중요한 비즈니스 이벤트를 설명하는 메시지다. 
  - 다른 컴포넌트는 이벤트를 구독하고 비즈니스 로직의 실행을 촉발하는 데 사용할 수 있다. 

- ##### 도메인 서비스

  - 도메인 서비스란 도메인 모델에서 애그리게이트 또는 밸류 오브젝트에 속하지 않는 비즈니스 로직을 담는 상태가 없는 객체다.

<br/>

# 느낀점

벨류 오브젝트, 애그리게이트, 도메인 서비스를 자세하게 알게 되었다.