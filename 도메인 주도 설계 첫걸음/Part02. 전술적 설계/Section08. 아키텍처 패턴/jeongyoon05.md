# 아키텍처 패턴

전술적 설계 의사결정에 대해 알아보자

시스템의 구성요소 간의 상호작용과 의존성을 조율하는 다양한 방법을 살펴본다.

<br/>

## 비즈니스 로직과 아키텍처 패턴

비즈니스 로직은 소프트웨어에서 가장 중요한 요소다.

아키텍처 패턴은 코드베이스의 다양한 측면에 대한 구성 원칙을 도입하고 이들 사이의 명확한 경계를 제시한다.

<br/>

## 계층형 아키텍처

> 가장 일반적인 아키텍처 패턴중 하나다.

코드베이스를 수평 계층으로 조직하고, 각 계층은 사용자와 상호작용, 비즈니스 로직의 구현, 그리고 데이터베이스의 저장과 같은 기술적 관심사 중 하나를 다룬다.

고전적인 형태의 계층형 아키텍처는 프레젠테이션 계층, 비즈니스 로직 계층, 데이터 접근 계층의 세가지 계층으로 구성된다. 

<br/>

## 프레젠테이션 계층

> 사용자와 상호작용을 하기 위한 프로그램의 사용자 인터페이스를 구현한다.

이 패턴의 원래 형태에서 이 계층은 웹 인터페이스 또는 데스크톱 인터페이스와 같은 그래픽 인터페이스를 나타낸다.

이 계층은 프로그램의 동작을 촉발하는 모든 동기식 또는 비동기식 수단과 같은 좀 더 광범위한 범주를 포함한다.

- 그래픽 사용자 인터페이스(GUI)
- 커맨드 라인 인터페이스(CLI)
- 다른 시스템과 연동하는 프로그래밍 API
- 에시지 브로커에서 이벤트에 대한 구독
- 나가는 이벤트를 발행하는 메시지 토픽

<br/>

#### 비즈니스 로직 계층

> 프로그램의 비즈니스 로직을 구현하고 묶는 것을 담당한다.

비즈니스 의사결정을 구현한다.

<br/>

#### 데이터 접근 계층

> 영속성 메커니즘에 접근할 수 있게 해준다.

원래 패턴에서는 이 계층이 시스템의 데이터베이스를 가리킨다.

그러나 프레젠테이션 계층의 경우처럼 현대 시스템에서는 이 계층이 좀 더 넓은 범위를 책임을 진다. 

1. 혁신적인 NoSQL이 출현한 이래로 여러 데이터베이스를 사용하는 시스템이 보편화됐다.
2. 정보 저장용으로 전통적인 데이터베이스뿐만 아니라 다양한 매체가 있다.
3. 이 계층은 프로그램의 기능을 구현하는데 필요한 다양한 외부 정보 제공자와 연동하는 것을 포함한다.

<br/>

#### 계층 간 커뮤니케이션

계층은 톱다운 커뮤니케이션 모델에 따라 연동한다.

<br/>

#### 변종(variation)

계층형 아키텍처 패턴을 확장해서 서비스 계층을 추가하는 것을 흔히 볼 수 있다.

<br/>

#### 서비스 계층

```
"가용한 오퍼레이션을 구축하고 각 오퍼레이션에서 애플리케이션의 응답을 조정하는 서비스 계층을 애플리케이션의 경계에 정의한다."
													  - <<엔터프라이즈 애플리케이션 아키텍처 패턴>>(위키북스, 2015)
```

서비스 계층은 프로그램의 프레젠테이션 계층과 비즈니스 로직 계층 사이의 중간 역할을 한다.

아키텍처 패턴의 컨텍스트에서 서비스 계층은 논리적 경계라는 것이 중요하다.

서비스 계층은 비즈니스 로직 계층으로의 관문 역할을 한다.

서비스 계층을 명시적으로 갖추면 몇 가지 장점이 생긴다.

- 동일한 서비스 계층을 여러 퍼블릭 인터페이스에서 재사용할 수 있다.
- 모든 관련 메서드를 한곳에 모으면 모듈화가 개선된다.
- 프레젠테이션 계층과 비즈니스 로직 계층의 결합도를 낮춘다.
- 비즈니스 기능을 테스트하기 쉬워진다.

<br/>

#### 용어

계층형 아키텍처에 사용되는 다른 용어를 봤을 수도 있다.

- 프레젠테이션 계층 = 사용자 인터페이스 계층
- 서비스 계층 = 애플리케이션 계층
- 비즈니스 로직 계층 = 도메인 계층 = 모델 계층
- 데이터 접근 계층 = 인프라스트럭처 계층

<br/>

#### 계층형 아키텍처를 사용하는 경우

비즈니스 로직과 데이터 접근 계층 간에는 의존성이 있다. 따라서 비즈니스 로직이 트랜잭션 스크립트 또는 액티브 레코드 패턴을 사용하여 구현된 시스템에 계층형 아키텍처 패턴이 적합하다.

도메인 모델을 구현하는 데 계층형 아키텍처 패턴을 적용하는 것은 어렵다. 도메인 모델에 서는 비즈니스 엔티티가 하부의 인프라스트럭처에 대해 의존성이 없어야 하고 그것을 몰라야 하기 때문이다.

<br/>

## 포트와 어댑터

포트와 어댑터 아키텍처는 계층형 아키텍처의 단점을 해결하고 좀 더 복잡한 비즈니스 로직을 구현하는데 적합하다.

<br/>

#### 용어

본질적으로 프레젠테이션 계층과 데이터 접근 계층 모두 데이터베이스, 외부 서비스, 사용자 인터페이스 프레임워크 등의 외부 구성요소와 연동하는 것을 표현한다.

<br/>

#### 의존성 역전 원칙

의존성 역전 원칙에서 비즈니스 로직을 구현하는 상위 수준의 모듈은 하위 수준의 모듈에 의존해서는 안 된다고 말한다. 그러나 전통적인 계층형 아키텍처에서 비즈니스 로직 계층은 인프라스트럭처 계층에 의존한다.

<br/>

#### 인프라 구성요소의 연동

포트와 어댑터 아키텍처의 핵심 목적은 인프라스트럭처 구성요소로부터 시스템의 비즈니스 로직을 분리하는 것이다.

인프라스트럭처 구성요소를 직접 참조하고 호출하는 대신, 비즈니스 로직 계층은 인프라스트럭처 계층이 구현해야 할 '포트'를 정의한다. 인프라스트럭처 계층은 '어댑터'를 구현한다. 

<br/>

#### 변형

포트와 어댑터 아키텍처는 헥사고날 아키텍처, 어니언 아키텍처, 그리고 클린 아키텍처로 알려졌다. 용어는 조금씩 다르다.

- 애플리케이션 계층 = 서비스 계층 = 유스케이스 계층
- 비즈니스 로직 계층 = 도메인 계층 = 핵심 계층

<br/>

#### 포트와 어댑터를 사용하는 경우

모든 기술적 관심사로부터 비즈니스 로직을 분리하는 것이 포트와 어댑터 아키텍처의 목적이므로 이 아키텍처는 도메인 모델 패턴을 사용하여 구현한 비즈니스 로직에 매우 적합하다.

<br/>

## CQRS

> 포트와 어댑터와 동일한 비즈니스 로직과 인프라스트럭처 관심사에 기반한다.

하지만 시스템의데이터를 관리하는 방식이 다르다.

이 패턴을 사용하려면 여러 영속 모델에 시스템의 데이터를 표현할 수 있다.

<br/>

#### 폴리글랏 모델링

대부분의 경우 단일 비즈니스 도메인 모델로 시스템의 모든 요구사항을 해결하기는 불가능하지는 않지만 어려울 수 있다.

완벽한 데이터베이스 대안으로 폴리글랏 영속성 모델이 있다. 이는 다양한 데이터 관련 요구사항을 구현하기 위해 여러 데이터베이스를 사용하는 것이다.

<br/>

##### 구현

이름에서 알 수 있듯이 이 패턴은 시스템 모델의 책임을 분리시킨다. 여기에는 커맨드 실행 모델과 읽기 모델의 두 유형이 있다.

<br/>

##### 커맨드 실행 모델

CQRS에서는 시스템의 상태를 수정하는 오퍼레이션을 전담으로 수행하는 단일 모델이 있다. 이 모델은 비즈니스 로직을 구현하고 규칙을 검사하며 불변성을 강화하는 데 사용된다.

<br/>

##### 읽기 모델(프로젝션)

시스템은 사용자에게 데이터를 보여주거나 다른 시스템에 정보를 제공하기 위해 필요한 만큼 모델을 정의할 수 있다.

읽기 모델은 읽기 전용이다. 시스템의 어떠한 오퍼레이션도 읽기 모델의 데이터를 직접 수정할 수 없다.

<br/>

#### 읽기 모델의 프로젝션

읽기 모델이 작동하려면 시스템은 커맨드 실행 모델에서 변경을 모든 읽기 모델로 프로젝션해야 한다.

읽기 모델의 프로젝션은 머터리얼라이즈 뷰의 개념과 유사하다.

<br/>

##### 동기식 프로젝션

동기식 프로젝션은 격차 해소 구독 모델을 통해 OLTP데이터의 변경사항을 가져온다.

- 프로젝션 엔진이 OLTP 데이터베이스로부터 마지막에 처리했던 체크포인트 이후에 추가되거나 갱신된 레코드를 조회한다.
- 프로젝션 엔진이 조회된 데이터를 이용해서 시스템의 읽기 모델을 재생성 또는 갱신한다.
- 프로젝션 엔진은 마지막으로 처리 레코드의 체크포인트를 저장한다. 이 값은 다음 처리 때 추가되거나 갱신된 레코드를 조회하는 데 사용된다.

<br/>

##### 비동기식 프로젝션

비동기식 프로젝션 시나리오에서 커멘드 실행 모델은 모든 커밋된 변경사항을 메시지 버스에 발행한다.

<br/>

#### 도전과제

비동기식 프로젝션 방식의 확실한 확장성과 성능의 장점에도 불구하고, 분산 컴퓨팅에서 문제가 발생하기 더 쉽다. 메시지의 순서가 잘못되거나 중복 처리되면 읽기 모델에 일관성 없는 데이터가 프로젝션된다.

<br/>

#### 모델분리

CQRS 아키텍처에서는 시스템 모델이 담당하는 책임은 그 타입에 따라 분리된다. 커맨드는 강한 일관성을 가진 커맨드 실행 모델에서만 동작한다. 질의는 읽기 모델과 커맨드 실행 모델을 포함하여 그 어떤 시스템의 영속 상태를 직접 수정할 수 없다.

커맨드 실행 메서드는 어떤 데이터도 반환해서는 안 된다는 것이다.

커맨드는 실행이 성공했는지 또는 실패했는지를 항상 호출자에게 알려야 한다.

<br/>

#### CQRS를 사용해야 하는 경우

CQRS 패턴은 여러 모델, 궁극적으로 다양한 종류의 데이터베이스에 저장된 동일한 데이터와 작동할 필요기 있는 애플리케이션에 유용하다.

CQRS는 이벤트 소싱 도메인 모델에도 적합하다. 이벤트 소싱 모델에서는 애그리게이트의 상태에 기반한 레코드 조회가 불가능하지만 CQRS는 상태를 질의할 수 있는 데이터베이스에 상태를 프로젝션하므로 이것이 가능하다.

<br/>

## 범위

계층형 아키텍처, 포트와 어댑터 아키텍처, CQRS는 시스템 전체에 적용하는 구성 원칙으로 취급하면 안된다.

동일한 타입의 하위 도메인도 다양한 비즈니스 로직과 아키텍처 패턴이 필요할 수 있다.

적절한 수직 경계는 모놀리식 바운디드 컨텍스트를 모듈회하고 커다란 진흙 덩어리가 되는 것을 방지하는 데 도움을 준다.

<br/>

## 결론 

계층형 아키텍처는 기술적 관심사에 따라 코드베이스를 분해한다. 이 패턴은 비즈니스 데이터 접근 구현을 결합시키므로 액티브 레코드 기반 시스템에 적합하다.

포트와 어댑터 아키텍처는 관계를 역전시킨다. 비즈니스 로직을 중심에 두고 모든 인프라스트럭처와의 의존성을 분리한다. 이 패턴은 도메인 모델 패턴을 구현하는 비즈니스 로직에 적합하다.

CQRS 패턴은 여러 모델에서 동일한 데이터를 표현한다. 이 패턴은 이벤트 소싱 도메인 모델에 기반한 시스템에 적합하지만 다양한 영속 모델을 사용할 필요가 있는 어떤 시스템에도 사용할 수 있다.

<br/>

# 느낀점

여러 아키텍처에 대해서 알게 되었다.